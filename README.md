# Surrogate EKMA Analysis of Urban Ozone Formation in Los Angeles (2024–2025)

This repository contains a complete, reproducible data-processing and analysis pipeline for a **Random Forest–based surrogate EKMA (Empirical Kinetic Modeling Approach)** study of urban ozone formation regimes in **Los Angeles County (CA)** during **2024–2025**.

The workflow uses **EPA AQS AirData hourly observations** to (i) build an hourly county dataset, (ii) construct temporal/spatial/pollutant features, (iii) impute missing values with **KNN**, (iv) train a **Random Forest** ozone model, and (v) generate **EKMA-like response surfaces** by scaling precursor proxies.

**No API keys are required.**

---

## What this repository does

1. **Download & ingest hourly AQS AirData ZIPs** (O₃, NO₂, CO, PM₂.₅)
2. **Filter to Los Angeles County** (`state_code = 06`, `county_code = 037`)
3. **Clean and merge** pollutants into a unified hourly dataset
4. **Feature engineering** (time encodings + spatial coordinates + pollutant predictors)
5. **Missing-data handling** via **KNN imputation** (only for imputation; not used for modeling)
6. **Random Forest ozone modeling** with a temporal train/test split
7. **Surrogate EKMA analysis** by scaling NO₂ (NOₓ proxy) and CO (VOC proxy) and averaging predictions under representative conditions
8. **Reproduce manuscript figures** via figure-specific scripts

---

## Data source

**EPA AQS AirData hourly ZIP files** (public; no API key required):

- `hourly_44201_2024.zip`, `hourly_44201_2025.zip` — O₃  
- `hourly_42602_2024.zip`, `hourly_42602_2025.zip` — NO₂  
- `hourly_42101_2024.zip`, `hourly_42101_2025.zip` — CO  
- `hourly_88101_2024.zip`, `hourly_88101_2025.zip` — PM₂.₅  

**Study region**
- Los Angeles County, California
- `state_code = 06`
- `county_code = 037`

**Study period**
- 2024–2025  
(To change years, edit `YEARS` in `code/01_download_aqs_airdata.R`.)

---

## Repository structure

```
surrogate-ekma-la-ozone/
├── code/
│   ├── 00_setup.R
│   ├── 01_download_aqs_airdata.R
│   ├── 03_fig41_temporal_patterns.R
│   ├── 04_fig42_weekend_effect.R
│   ├── 05_fig43_rf_performance.R
│   ├── 06_fig44_rf_perm_importance.R
│   ├── 07_fig45_rf_ekma_surface.R
│   ├── run_all.R
│   └── utils.R
├── data_raw/
│   └── aqs/
├── data_proc/
│   └── la_hourly_aqs_2024_2025.rds
├── figures/
├── results/
└── README.md
```

---

## Methods summary

### Missing data (KNN imputation)

Missing observations are imputed using **K-nearest neighbors (KNN)** on **standardized** predictors derived from:
- pollutant measurements,
- temporal features,
- spatial coordinates.

KNN is used **only** to impute missing values.

### Random Forest ozone model

Surface ozone is modeled with a **Random Forest regressor** using predictors including:
- NO₂, CO, PM₂.₅  
- cyclic time encodings (hour, month, day-of-week)  
- latitude, longitude

### Model evaluation

Temporal train/test split:
- **Training**: 2024  
- **Testing**: 2025  

Reported metrics include **R²**, **RMSE**, and **permutation importance**.

### Surrogate EKMA analysis

EKMA-like ozone response surfaces are generated by scaling:
- **NO₂** (proxy for NOₓ)
- **CO** (proxy for VOCs)

Other covariates (time/location and any fixed context used in the script) are held constant, and predictions are aggregated over representative conditions (e.g., summer afternoon windows, if specified in the figure script).

---

## Reproducing the results

### Run the full pipeline

From the repository root:

```bash
Rscript code/run_all.R
```

### Minimal execution order

If running scripts individually:

```text
code/00_setup.R
code/01_download_aqs_airdata.R
code/03_fig41_temporal_patterns.R
code/04_fig42_weekend_effect.R
code/05_fig43_rf_performance.R
code/06_fig44_rf_perm_importance.R
code/07_fig45_rf_ekma_surface.R
```

---

## Notes

- The pipeline is designed to run end-to-end from raw AQS ZIP files to processed data, figures, and results.
- If you change `YEARS`, also update output filenames and any figure scripts that assume a specific processed dataset name.
